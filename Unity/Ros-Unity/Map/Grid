public struct PatchGrid
{
    public int width;
    public int height;
    public float resolution;
    public float originX, originY;
    // Already radius when initialize.
    public float orientation;
    public sbyte[] data; // -1, 0, 100

    public static readonly PatchGrid T1Map10x10 = new PatchGrid
    {
        width = 10,
        height = 10,
        resolution = 10f,
        originX = -0.5f,
        originY = -0.5f,
        data = new sbyte[]
        {
        -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        -1,  0,  0,  0,  0,  0,  0,  0,  0, -1,
        -1,  0, -1, -1,  0,  0, -1, -1,  0, -1,
        -1,  0, -1, -1,  0,  0, -1, -1,  0, -1,
        -1,  0,  0,  0,  0,  0,  0,  0,  0, -1,
        -1,  0,100,100,  0,  0,100,100,  0, -1,
        -1,  0,100,100,  0,  0,100,100,  0, -1,
        -1,  0,  0,  0,  0,  0,  0,  0,  0, -1,
        -1,  0,  0,  0,  0,  0,  0,  0,  0, -1,
        -1, -1, -1, -1, -1, -1, -1, -1, -1, -1
        }
    };
    public static readonly PatchGrid T2Map20x14 = new PatchGrid
    {
        width = 20,
        height = 14,
        resolution = 5f,
        originX = -1.0f,
        originY = -0.75f,
        data = new sbyte[]
        {
        // 行 0-2: 上边界和墙壁
        -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        -1,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100, -1,
        -1,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100, -1,
        
        // 行 3-11: 走廊结构
        -1,100,100,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,100,100,100, -1,
        -1,100,100,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,100,100,100, -1,
        -1,100,100,  0,  0, -1, -1, -1, -1,  0,  0, -1, -1, -1, -1,  0,100,100,100, -1,
        -1,100,100,  0,  0, -1, -1, -1, -1,  0,  0, -1, -1, -1, -1,  0,100,100,100, -1,
        -1,100,100,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,100,100,100, -1,
        -1,100,100,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,100,100,100, -1,
        -1,100,100,100,100,100,  0,  0,100,100,100,100,100,  0,  0,100,100,100,100, -1,
        -1,100,100,100,100,100,  0,  0,100,100,100,100,100,  0,  0,100,100,100,100, -1,
        
        // 行 12-14: 下边界
        -1,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100, -1,
        -1,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100, -1,
        -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1
        }
    };
    public static readonly PatchGrid T3Map64x32 = new PatchGrid
    {
        width = 64,
        height = 32,
        resolution = 1f,    // 10cm 分辨率
        originX = -3.2f,      // 中心在 (0,0)，范围 [-3.2, 3.2] × [-1.6, 1.6] 米
        originY = -1.6f,
        data = new sbyte[]
            {
            // 行 0-3: 上边界
            100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,
            100, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,100, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,100,
            100, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,100, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,100,
            100, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,  0, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,100,
            
            // 行 4-7: 房间1的墙壁和自由空间
            100, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,100,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,100, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,100,
            100, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,100,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,100, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,100,
            100, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,100,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,100, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,100,
            100, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,100,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,100,
            
            // 行 8-11: 走廊区域
            100, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,100,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,100, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,100,
            100, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,100,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,100, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,100,
            100, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,100, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,100,
            100, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,100,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,100, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,100,
            
            // 行 12-15: 中央走廊和障碍物
            100, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,100,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,100, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,100,
            100, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,100,  0,  0,  0,  0,  0,  0,100,100,100,100,  0,  0,100,100,100,100,  0,  0,100,100,100,100,  0,  0,  0,  0,  0,  0,  0,  0,100, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,100,
            100, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,100,  0,  0,  0,  0,  0,  0,100,100,100,100,  0,  0,100,100,100,100,  0,  0,100,100,100,100,  0,  0,  0,  0,  0,  0,  0,  0,100, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,100,
            100, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,100,  0,  0,  0,  0,  0,  0,100,100,100,100,  0,  0,100,100,100,100,  0,  0,100,100,100,100,  0,  0,  0,  0,  0,  0,  0,  0,  0, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,100,
            
            // 行 16-19: 房间2区域
            100, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,100,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,100, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,100,
            100, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,100,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,100, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,100,
            100, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,100,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,100, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,100,
            100, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,100, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,100,
            
            // 行 20-23: 自由空间和障碍物
            100, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,100,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,100, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,100,
            100, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,100,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,100, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,100,
            100, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,100,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,100, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,100,
            100, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,100,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,100,
            
            // 行 24-27: 下部分房间
            100, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,100,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,100, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,100,
            100, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,100,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,100, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,100,
            100, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,100,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,100, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,100,
            100, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,100, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,100,
            
            // 行 28-31: 下边界
            100, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,100, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,100, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,100, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,100,
            100, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,100, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,100, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,100, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,100,
            100, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,100, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,100, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,100, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,100,
            100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100
            }
    };
    public static PatchGrid CreateTestRefreshGrid(float oriX, float oriY, float oriYaw = 0, int w = 32, int h = 32)
    {
        PatchGrid grid = new PatchGrid
        {
            width = w,
            height = h,
            resolution = 5f,
            orientation = oriYaw * Mathf.Deg2Rad,
            originX = oriX,
            originY = oriY,
            data = new sbyte[w * h]
        };

        for (int y = 0; y < h; y++)
        {
            for (int x = 0; x < w; x++)
            {
                int index = y * w + x;

                // 棋盘格模式：0 和 100 交错
                grid.data[index] = (sbyte)100;
            }
        }

        return grid;
    }

}

public struct CreateMapMessage
{
    public int cellHorCount;
    public int cellVecCount;
    public float resolution;
    public float originX, originY;
    public sbyte defaultData;

    public static readonly CreateMapMessage Test128x128Map = new CreateMapMessage()
    {
        cellHorCount = 128,
        cellVecCount = 128,
        resolution = 5f,
        originX = 0,
        originY = 0,
        defaultData = -1
    };
    public static CreateMapMessage GetMapMessage(int Width, int Height, float Resolution = 5f, float OriginX = 0, float OriginY = 0, sbyte DefaultData = -1)
    {
        return new CreateMapMessage
        {
            cellHorCount = Width,
            cellVecCount = Height,
            resolution = Resolution,
            originX = OriginX,
            originY = OriginY,
            defaultData = DefaultData
        };
    }
}

public static class PatchMath
{
    public struct PatchTransform
    {
        public Vector2 origin;
        public float cos;
        public float sin;
        public float widthMeters;
        public float heightMeters;
    }

    public struct PatchTransform_Burst
    {
        public float2 origin;
        public float cos;
        public float sin;
        public float widthMeters;
        public float heightMeters;
    }

    public static PatchTransform MakePatch(float patchLeftWorldX, float patchLeftWorldY, float patchYawRad, float widthMeters, float heightMeters)
    {
        PatchTransform pt = new PatchTransform();
        pt.origin = new Vector2(patchLeftWorldX, patchLeftWorldY);
        pt.cos = Mathf.Cos(-patchYawRad);
        pt.sin = Mathf.Sin(-patchYawRad);
        pt.widthMeters = widthMeters;
        pt.heightMeters = heightMeters;
        return pt;
    }

    public static PatchTransform_Burst MakePatch_Burst(float patchLeftWorldX, float patchLeftWorldY, float patchYawRad, float widthMeters, float heightMeters)
    {
        PatchTransform_Burst ptb = new PatchTransform_Burst();
        ptb.origin = new float2(patchLeftWorldX, patchLeftWorldY);
        ptb.cos = Mathf.Cos(-patchYawRad);
        ptb.sin = Mathf.Sin(-patchYawRad);
        ptb.widthMeters = widthMeters;
        ptb.heightMeters = heightMeters;
        return ptb;
    }

    public static Vector2 WorldToPatchLocal(in PatchTransform pt, float wx, float wy)
    {
        float dx = wx - pt.origin.x;
        float dy = wy - pt.origin.y;
        
        // inverse rotation: rotate by -yaw -> multiply by R^T
        // make cell inverse rotate by patch's rotate point 
        
        //float px = pt.cos * dx + pt.sin * dy;
        //float py = -pt.sin * dx + pt.cos * dy;
        float px = dx * pt.cos - dy * pt.sin;
        float py = dx * pt.sin + dy * pt.cos;

        return new Vector2(px, py);
    }

    public static float2 WorldToPatchLocal_Burst(PatchTransform_Burst pt, float wx, float wy)
    {
        float dx = wx - pt.origin.x;
        float dy = wy - pt.origin.y;

        float px = dx * pt.cos - dy * pt.sin;
        float py = dx * pt.sin + dy * pt.cos;

        return new float2(px, py);
    }
}
